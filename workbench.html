<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>doT workbench</title>
<style>
textarea { display: block; width: 100%; height: 100px; }
pre { white-space: pre-wrap; }
</style>
<style>.ace_n9dotToken { background: rgba(0, 0, 0, 0.05); } .ace_n9dotExpression {	background: rgba(0, 128, 0, 0.05); }</style>
</head><body>
<div>Source (<button id="loadSource">Load</button>, <button id="saveSource">Save</button>):</div>
<pre id="source">Loading...</pre>
<div>Compiled template (<input type="checkbox" id="beautify"> beautify): <button id="addLineToSource">v</button></div>
<pre id="compiled">not yet compiled</pre>
<div>Context data (JSON) (<input type="checkbox" id="hideData"> hide, <button id="loadData">Load</button>, <button id="saveData">Save</button>):</div>
<textarea id="data"></textarea>
<pre id="diag">not yet evaluated</pre>
<pre id="error">not yet evaluated</pre>
<div>Output (<input type="checkbox" id="hideOutput"> hide, <button id="viewInViewer">View in viewer</button>, <button id="saveOutput">Save</button>):</div>
<pre id="output">not yet evaluated</pre>
<script src="https://cdn.rawgit.com/n9/ace-builds/38eb9a5/src/ace.js"></script>
<script>
	var aceSource = ace.edit('source');
	aceSource.setOptions({
		minLines: 10,
		maxLines: 20
	});
	aceSource.session.setMode("ace/mode/n9dot");
	
	var aceCompiled = ace.edit('compiled');
	aceCompiled.setOptions({
		minLines: 0,
		maxLines: 20,
		useWorker: false,
		readOnly: true
	});
	aceCompiled.session.setMode("ace/mode/javascript");		
</script>
<script src="doT.js"></script>
<script src="https://cdn.rawgit.com/jshint/jshint/2.8.0/dist/jshint.js"></script>
<script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.5.5/js/lib/beautify.js"></script>
<script>
	function E(id) { return document.getElementById(id); }

	var eData = E('data');
	var eHideData = E('hideData');
	var eOutput = E('output');
	var eHideOutput = E('hideOutput');
	var eDiag = E('diag');
	var eBeautify = E('beautify');
	var eViewInViewer = E('viewInViewer');
	var eLoadData = E('loadData');
	var eSaveData = E('saveData');
	var eSaveOutput = E('saveOutput');
	var eAddLineToSource = E('addLineToSource');
	var eError = E('error');
	var eLoadSource = E('loadSource');
	var eSaveSource = E('saveSource');
	var data;
	
	var viewerWindow;
	
	window.onmessage = function(evt) {
		evt.source.postMessage(eOutput.textContent, '*');
	};
	
	var dotGlobals = {};
	doT.globals().forEach(function(v) {
		dotGlobals[v] = true;
	});
	
	function dataUpdated() {
		var dataJson = eData.value;
		try {
			localStorage.setItem('data', dataJson)
		} catch (e) {
			// ignore
		}
		
		try {
			data = JSON.parse(dataJson);
		} catch (e) {
			eOutput.textContent = e;
			return;
		}

		doTcompile();
	}
	
	function saveFile(fileName, content, contentType) {
		var a = document.createElement('a');
		a.style.display = 'none';
		a.download = fileName;
		a.href = 'data:' + contentType + ';base64,' + btoa(content);
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);	
	}
	
	function loadTextFile(action, accept) {
		var i = document.createElement('input');
		i.type = 'file';
		if (accept)
			i.accept = accept;
		i.style.display = 'none';
		i.onchange = function(evt) {
			var reader = new FileReader();
			reader.onload = function() {
				action(reader.result);
			};
			reader.readAsText(evt.target.files[0]);
		};
		document.body.appendChild(i);
		i.click();
		document.body.removeChild(i);	
	}	

	function doTcompile() { 
		var source = aceSource.session.getValue();
		var beautify = eBeautify.checked;
		try {
			localStorage.setItem('source', source)
			localStorage.setItem('nobeautify', beautify ? "" : "t")
		} catch (e) {
			// ignore
		}
		
		var compiled; 
		try { 
			compiled = doT.template(source);
			if (beautify)
				compiled = js_beautify(compiled);
			
			aceCompiled.session.doc.setValue(compiled);
		} catch (e) {
			aceCompiled.session.setValue(e.message);
			return;
		}
				
		try {
			var r = JSHINT(compiled, {
				eqeqeq: true,
				freeze: true,
				expr: true,
			}, dotGlobals);
			var errors = JSHINT.errors.filter(function(e) { return e; });
			var undefs = JSHINT.undefs;
			var errorsText = errors.map(function(e) { return "\n[" + e.line + "," + e.character + "] " + e.code + ": " + e.reason; }).join();
			if (undefs.length)
				errorsText += "\r\nundefs: " + undefs.map(function(u) { return "\n[" + u[2].line + "," + u[2].character + "] " + u[2].value; }).join();
			
			eDiag.textContent = errorsText;
			aceCompiled.session.setAnnotations(errors.map(function(e) { return { row: e.line - 1, column: e.character - 1, text: e.reason, type: e.code[0] === 'W' ? "warning" : "error" };}).concat(undefs.map(function(u) { return { row: u[2].line - 1, column: u[2].character - 1, text: u[2].value + " is not defined", type: "info" };})));
		} catch (e) {
			eDiag.textContent = e;
		}
		
		var compiledFunc;
		try { 
			compiledFunc = doT.wrap(compiled);
		} catch (e) {
			eError.textContent = "Compile error: " + e;
			return;
		}		
		
		var output;
		try { 
			output = compiledFunc(new doT.Context(), data, null);
		} catch (e) {
			eError.textContent = "Runtime error: " + e;
			return;
		}

		try { 
			eOutput.textContent = output;
			if (viewerWindow && !viewerWindow.closed)
				viewerWindow.postMessage(output, "*");
		} catch (e) {
			eError.textContent = "Set and post error: " + e;
			return;
		}
		eError.textContent = "";
	}
		
	var s = localStorage.getItem('source');
	if (s === null || s === '')
		s = 'Hello {{it}}!';
	aceSource.session.setValue(s);
	aceSource.on('input', doTcompile);
	var b = localStorage.getItem('nobeautify');
	eBeautify.checked = !b;
	eBeautify.onclick = doTcompile;
	eBeautify.onchange = doTcompile;
	var d = localStorage.getItem('data');
	if (d === null || d === '')
		d = '"World"';
	eData.value = d;
	eData.onchange = dataUpdated;
	eData.onkeyup = dataUpdated;
	eHideData.onchange = function() {
		eData.style.display = eHideData.checked ? "none" : "block";
	};
	eHideOutput.onchange = function() {
		eOutput.style.display = eHideOutput.checked ? "none" : "block";
	};
	
	eAddLineToSource.onclick = function() {
		aceSource.setOption('maxLines', aceSource.getOption('maxLines') + 5);
	};
	
	eViewInViewer.onclick = function() {
		if (!viewerWindow || viewerWindow.closed)
			viewerWindow = window.open("viewer.html", "_blank");
		else
			viewerWindow.focus();
		eHideOutput.checked = false;
		eHideOutput.click();
	};
	
	eLoadSource.onclick = function() {
		loadTextFile(function(t) {
			aceSource.session.setValue(t);
			doTcompile();
		}, '.dt');		
	};
	
	eSaveSource.onclick = function() {
		saveFile("template.dt", aceSource.session.getValue(), "text/plain");	
	};
	
	eLoadData.onclick = function() {
		loadTextFile(function(t) {
			eData.value = t;
			dataUpdated();
		}, '.json');
	};
	
	eSaveData.onclick = function() {
		saveFile('data.json', eData.value, 'text/json');
	};

	eSaveOutput.onclick = function() {
		var style;
		var content = eOutput.textContent.replace(/<style>([^<]*)<\/style>/, function(w, s) {
			style = s;
			return "";
		})
		var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>doT viewer</title><style>' 
			+ style + '</style></head><body>' + content + '</body></html>';
		saveFile("output.html", html, "text/html");
	};
	dataUpdated();
</script>
</body></html>
